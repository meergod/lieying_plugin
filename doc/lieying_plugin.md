:: lieying_plugin.md, language *Chinese* (`zh_cn`)
:: *last_update* `2015-07-11 22:53 GMT+0800 CST`

# 猎影插件接口定义 version 0.2.0-test.1

author: `sceext <sceext@foxmail.com>`

此文件用来说明 猎影插件接口 的定义. 


## 内容目录

+ **[0. 基本说明](#0-基本说明)**
  
  + **[0.1 猎影](#01-猎影)**
  + **[0.2 猎影插件](#02-猎影插件)**
  + **[0.3 猎影插件接口](#03-猎影插件接口)**

+ **[1. 猎影插件的格式](#1-猎影插件的格式)**
  
  + **[1.1 编程语言 (`python3`)](#11-编程语言-python3)**
  + **[1.2 打包格式 (`zip`)](#12-打包格式-zip)**
  + **[1.3 入口文件 (`run.py`)](#13-入口文件-runpy)**
  + **[1.4 接口函数](#14-接口函数)**
  + **[1.5 错误处理](#15-错误处理)**

+ **[2. 猎影插件接口函数定义](#2-猎影插件接口函数定义)**
  
  + **[2.1 `GetVersion()`](#21-getversion)**
  + **[2.2 `StartConfig()`](#22-startconfig)**
  + **[2.3 `Parse()`](#23-parse)**
  + **[2.4 `ParseURL()`](#24-parseurl)**

+ **[3. 示例](#3-示例)**


## 0. 基本说明

### 0.1 猎影

**猎影** 是一款 视频下载软件, 能够下载许多 在线视频网站 的视频. 
并且 界面 简洁美观, 方便易用. 

猎影 的 **官方网站** 是 <http://lieying.ilewo.cn/>

### 0.2 猎影插件

**猎影插件** 是 *猎影* 的 *插件*, 是为了 **补充** 或 **增强** 猎影的功能. 

目前支持的 插件类型 有:

+ **解析插件** (*parse*)
  
  *解析插件* 提供 **解析** 功能. 
  
  即 输入 视频网站页面的 URL, 或者 视频名称 等, 
  由 解析插件 解析出 视频文件的下载地址, 视频标题 等信息. 
  
  然后 由猎影进行下载. 

### 0.3 猎影插件接口

**猎影插件接口** 就是 *猎影* 和 *猎影插件* 之间定义的接口. 

*猎影插件接口* 使用 **语义化版本**号 (semver 2.0.0, <http://semver.org/lang/zh-CN/>) 
来定义 接口 的版本, 以便处理 兼容性, 功能更新 等问题. 


## 1. 猎影插件的格式

### 1.1 编程语言 (`python3`)

*猎影插件* 使用 **[python3](https://docs.python.org/3/)** 作为 编程语言. 

*猎影* 会附带 **完整**的 `python 3.4` 运行环境, 包括 标准库, 和默认随 `python3` 安装的软件包. 
但是不附带其他使用 `pip` 安装的软件包. 

### 1.2 打包格式 (`zip`)

*猎影插件包* 是标准的 `zip` 格式的 **压缩包**. 
压缩包 中可包含任意数量的 文件, 其中只有一个 `run.py` 即 猎影插件的**入口文件**, 是**必须**的. 

### 1.3 入口文件 (`run.py`)

`run.py` 是 *猎影插件* 的 **入口文件**. 
`run.py` **必须**位于 压缩包 的**指定位置**. 

在 **指定位置** 只能有 1 个 `run.py` 文件. 

`run.py` 可用的 **指定位置** 有:

+ 压缩包 **根目录** 下 
+ 压缩包 根目录 下只有一个文件夹, 且 `run.py` 位于此 唯一 的文件夹下 

**比如**: 
`run.py` 有如下 2 种位置:

**1.** 假设 插件压缩包 根目录 为 `root`
```
 - root/
     run.py 
```

**2.** 假设 根目录 下只有一个 `plugin` 文件夹
```
 - root/
     - plugin/
         run.py
```

### 1.4 接口函数

`run.py` 中定义有若干 **接口函数**. 

使用 插件 时, 猎影会先 **导入** `run.py` 这个 python 模块, 然后调用其中的函数. 

**举例说明**: 猎影导入 `run.py` 的动作 相当于 python 中的 `import run`, 
调用其中 `GetVersion()` 函数的动作相当于 python 中的 `run.GetVersion()` 

目前定义的 接口函数 有:

+ `GetVersion()`
+ `StartConfig()`

> 

+ `Parse()`
+ `ParseURL()`

具体的 函数定义, 包括 参数, 返回值, 功能说明, 等, 请见[下文](#2-猎影插件接口函数定义). 

### 1.5 错误处理

当插件的 *接口函数* 执行中遇到错误, 请使用 `python` 的 `raise` 语句抛出一个错误. 

猎影会 **显示详细的错误信息**. 

比如

```
raise Exception('can not load page: http 404')
```

建议抛出错误时, 尽可能给出有用的详细错误信息, 以便帮助调试. 


## 2. 猎影插件接口函数定义

### 2.1 `GetVersion()`

([`GetVersion()` 示例](#32-测试-getversion))

+ **函数定义**
  
  ```
  def GetVersion()
  ```
  **注意**: **所有类型**的插件都**必须**定义该接口函数. 

+ **功能说明** <br />
  用于返回插件的版本号等有关信息. 
  具体返回的信息及其格式, 请见 *返回值* 说明. 

+ **参数**
  
  **无** <br />
  此函数没有定义参数. 

+ **返回值**
  
  类型: **`json` 字符串**
  
  json 信息结构: 
  
  ```
  {
      "port_version" : "0.2.0", 
      "type" : "", 
      "uuid" : "", 
      "version" : "", 
      "name" : "", 
      
      "filter" : [], 
      
      "author" : "", 
      "copyright" : "", 
      "license" : "", 
      "home" : "", 
      "note" : ""
  }
  ```
  
  以下项目, **所有类型**的插件都**必须**定义: 
  
  + **`port_version`** 类型: 字符串 <br />
    插件所使用的 *猎影插件接口* 的 **版本号**. 
    
    [当前](#03-猎影插件接口) 版本号是 `0.2.0`
  
  + **`type`** 类型: 字符串 <br />
    插件类型. 
    
    目前支持的 [插件类型](#02-猎影插件) 有
    
    + **`parse`**: 解析插件
  
  + **`uuid`** 类型: 字符串 <br />
    插件的 `uuid` 标识. 
    
    猎影 将**仅根据** *uuid* 来识别一个插件, 而不用 *插件名称* 等其它信息. 
    就是说, 只要 uuid 相同, 猎影就会认为这是同一个插件. 
    
    开始写一个 *猎影插件* 时, 应该使用 uuid 生成软件 (比如 `uuidgen`) 为此 插件 生成一个 `uuid`. 
    
    在发布插件的新版本时, **除非故意**这么做, 否则**不要修改**此插件的 *uuid*. 
    猎影会提示插件升级, 并且使用 新版插件 替换 旧版插件. 
  
  + **`version`** 类型: 字符串 <br />
    插件 版本号. 
    
    这个是 插件 自己的 版本号. 
    使用何种版本号规范, 由插件自己决定. 
    *猎影插件接口* 不做统一规定. 
  
  + **`name`** 类型: 字符串 <br />
    插件名称. 
    
    这个 *插件名称* 将显示在 *猎影* 的 *插件列表* 中. 
    
    **注意**: 猎影 不使用 *插件名称* 来唯一识别一个插件, 而是使用 `uuid`. 
  
  
  以下项目, 类型为 **`parse`** *(解析插件)* 的插件, **需要**定义. 
  
  + **`filter`** 类型: 数组 (`list`, `[]`, `Array`) <br />
    返回 `Parse()` 函数 支持的 文本输入的 *正则表达式* 数组. 
    数组内容为 字符串, 每个字符串 是一个 正则表达式. 
    
    在调用插件的 `Parse()` 函数之前, 猎影会 尝试 使用 `filter` 数组中的 
    *正则表达式* 匹配 *输入的字符串*. 如果匹配, 将会调用 此插件, 否则不会. 
  
  
  以下项目, **所有类型** 的插件都 **可以** 定义, 也就是说, 是 *可选*的项目, 不是必须定义. 
  
  + **`author`** 类型: 字符串 <br />
    插件 的 作者信息. 
  
  + **`copyright`** 类型: 字符串 <br />
    插件 的 版权信息. 
  
  + **`license`** 类型: 字符串 <br />
    插件 使用的 **许可证** (*license*). 
    
    比如 `GNU GPLv3+`, `MIT`, `unlicense`, 等. 
  
  + **`home`** 类型: 字符串 <br />
    插件 的 首页地址. 
    
    可以是 插件的 官方网站, 插件的 github 项目主页, 等. 
  
  + **`note`** 类型: 字符串 <br />
    插件 的 描述信息. 

+ **更多说明**
  
  + 插件可以在 `GetVersion()` 的返回的结果中 自己添加 一些其它的信息. 
    然而, 猎影 并不保证会使用这些信息, 猎影 可能直接忽略它们. 
    
    但是, 已经被 *猎影插件接口* 定义的项目, **必须**按照 *猎影插件接口* 定义的方式使用. 

### 2.2 `StartConfig()`

(`StartConfig()` 没有示例)

+ **函数定义**
  
  ```
  def StartConfig()
  ```
  **注意**: **所有类型**的插件都**必须**定义该接口函数. 

+ **功能说明** <br />
  用于启动插件自带的配置程序. 
  
  猎影插件管理界面, 会提供 *配置插件* 按钮. 
  用户点击此按钮之后, 猎影会调用此函数, 通知插件用户想要启动配置程序. 
  
  剩下的全部事情, 由插件自己处理. 

+ **参数**
  
  **无** <br />
  此函数没有定义参数. 

+ **返回值**
  
  **无** <br />
  此函数没有定义返回值. 

+ **更多说明**
  
  + 建议使用 python3 自带的 [`tkinter`](https://docs.python.org/3/library/tk.html) 
    组件提供图形界面的配置程序. 
  
  + 如果插件不支持配置, 或者没有自带的配置程序, 建议使用 `raise` 抛出错误. 
    
    这样猎影将有机会提示用户插件不支持配置. 
  
  + 插件可以自行使用配置文件保存配置信息. 配置文件可以与插件的 python 代码放在一起. 
    
    猎影不会处理插件配置信息的保存, 插件需要自行处理. 

### 2.3 `Parse()`

([`Parse()` 示例](#33-测试-parse))

+ **函数定义**
  
  ```
  def Parse(input_text)
  ```
  **注意**: 以下类型的插件需要定义此接口函数:
  + `parse` (解析插件)

+ **功能说明**

+ **参数**
  
  + **`input_text`** 类型: 字符串. 
    
    <!-- TODO -->

+ **返回值**
  
  类型: **`json` 字符串**
  
  json 信息结构: 
  
  ```
  {
  }
  ```

<!-- TODO -->

+ **更多说明**

### 2.4 `ParseURL()`

([`ParseURL()` 示例](#34-测试-parseurl))

+ **函数定义**
  
  ```
  def ParseURL(url, format, i_min=None, i_max=None)
  ```
  **注意**: 以下类型的插件需要定义此接口函数:
  + `parse` (解析插件)

+ **功能说明**

+ **参数**
  
  + **`url`** 类型: 字符串. 
  
  + **`format`** 类型: 字符串. 
  
  + **`i_min`** 类型: 整数 或 None. 
  
  + **`i_max`** 类型: 整数 或 None. 

+ **返回值**
  
  类型: **`json` 字符串**
  
  json 信息结构: 
  
  ```
  {
  }
  ```

<!-- TODO -->

+ **更多说明**


## 3. 示例

### 3.1 导入插件, 其他初始化工作

```
$ python
Python 3.4.3 (default, Mar 25 2015, 17:13:50) 
[GCC 4.9.2 20150304 (prerelease)] on linux
Type "help", "copyright", "credits" or "license" for more information.
>>> import run
>>> import json
>>> def p(o):
...     print(json.dumps(json.loads(o), indent=4, sort_keys=True, ensure_ascii=False))
... 
>>> 
```

其中定义的 p() 函数, 用于解析插件返回的 json 字符串, 并重新打印出来. 

### 3.2 测试 `GetVersion()`

```
>>> v = run.GetVersion()
>>> p(v)
{
    "author": "sceext <sceext@foxmail.com>",
    "copyright": "copyright 2015 sceext All rights reserved. ",
    "filter": [
        "^http://[a-z]+\\.iqiyi\\.com/.+\\.html"
    ],
    "home": "https://github.com/sceext2/parse_video/tree/output-easy",
    "license": "GNU GPLv3+",
    "name": "parse_video_7lieying_plugin57 (plugin version 0.11.2, kernel version 0.3.5.1) license GNU GPLv3+ ",
    "type": "parse",
    "uuid": "ebd9ac19-dec6-49bb-b96f-9a127dc4d0c3",
    "version": "0.11.2"
}
>>> 
```

### 3.3 测试 `Parse()`

### 3.4 测试 `ParseURL()`


<!-- TODO -->

:: end lieying_plugin.md, <https://github.com/sceext2/lieying_plugin>


